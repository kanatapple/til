# 自動セミコロン挿入

http://www.ecma-international.org/ecma-262/7.0/index.html#sec-automatic-semicolon-insertion
http://blog.tai2.net/automatic_semilocon_insertion.html

自動セミコロン挿入とは
1. 次の条件を満たすとき、プログラムが文法的に許可されないトークンを含むならば、セミコロンが挿入される。 
(a) 当該トークンの前に改行がある、または、(b) 当該トークンが閉じ中括弧である。
2. ファイル末尾に到達したとき、セミコロンを挿入しなければプログラムを解釈できないならば、セミコロンが挿入される。
3. Restricted Productionが出現したときに、文法既定で`[no LineTerminator here]`と記述されている場所に改行があるならば、セミコロンが挿入される。

1 のトークンとは
```
文法上の最小の構成要素、1 2 3 "abc"といった数値や文字列リテラル、 if,while,for,functionといったキーワード、+,-,=などの記号はすべてトークン
```

## 具体例

```javascript
{ 1
2 } 3
```

これは

```javascript
{ 1
;2 ;} 3;
```

こう挿入される

1 2というトークンの列は文法的に許されないが、2というトークンの前に改行があるため、セミコロンが挿入される  
また、2の直後に閉じ中括弧が来ることも文法的に許されないが、セミコロンが挿入されることにより文法的に許可されるコードになる  
これらは、(1)のルールで説明できる  
また、このファイルの末尾に到達した状態では、文法的に許可されない状態になるので、(2)のルールによりセミコロンが挿入される

## Restricted Production

JavaScriptでは、基本的にトークンは改行、スペース、タブなどの最低1個の空白文字で区切られ、空白文字の数や種類を増やしたり減らしたりしても文の意味は変わらない  
これは、CやJavaなどのいわゆるC言語系と言われるようなプログラミング言語に共通する特徴

しかし、JavaScriptには一部例外があり、return, throw, break, continue, ++, —といったトークンの直後または直前の区切りの空白に限っては、その中に改行が含まれる場合と含まれない場合とで、文の意味が変わる  
これら6種類の要素がRestricted Productionと呼ばれるもの
ECMAScriptの文法定義で、Restricted Productionの前後には、`[no LineTerminator here]`という文言が書かれている  
ここに改行が入ると、自動的にセミコロンが挿入される

```javascript
return
a + b
```

これが

```javascript
return;
a + b;
```

このようになる

## 自動セミコロン挿入の弊害

例えば、オブジェクトを関数から返したい時に

```javascript
return {
    a: 1,
    b: 2,
    c: 3
};
```

であれば正しく返るが

```javascript
return 
{
    a: 1,
    b: 2,
    c: 3
};
```

だと文が区切られてしまうので、関数の返り値は undifined になる

また、下記のような場合

```javascript
a = b + c

(function() {
    var x, y, z;
})()
```

c の後にセミコロンが挿入されそうだが、実際はされない  
なぜなら、c の後の()は関数呼び出しと解釈することが可能だから  
つまり、関数オブジェクトを引数に取る関数呼び出しと解釈されるため
